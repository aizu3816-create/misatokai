<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<title>アクセス集計表</title>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tablesorter@2.32.0/dist/js/jquery.tablesorter.min.js"></script>
<style type="text/css">
body {
	margin: 0;  padding: 0;
	width: 100%;  height: auto;
	text-align: center;
	justify-content: center;
}
#title {
	font: bold 13px "メイリオ";
	margin: 0 auto;
}
table,th,td {
	border-collapse:collapse;
	border:1px solid silver;
	height:15px;
	font-size:12px;
	text-align: center;
}
#dTbl {
	margin: 0 auto;
}
.w1 { width: 60px; }
.w2 { width: 45px; }
.w3 { width: 35px; }
.w4 { width: 25px; }
.clk { cursor: pointer; }
.left { text-align: left; }
</style>
</head>
<body oncontextmenu="return false;">
<p id="title">月別アクセス数</p>
<div id="t_area"></div>
<div id="detail"></div>
<script>
var acData = [];
var acTbl = [];		// 0:No 1:年月日 2:cnt 3:IPAddr 4:時分 5:秒以下 6:UserAgent
var obj = {};
readData2acTbl();

// ============================================================================ readData
function readData2acTbl() {
	obj['id']  = 'select';
	obj['db']  = 'count/count.db';
	obj['sql'] = 'select * from history order by substr(日付,1,10) desc,IPADDR;';
	$.post('../misato.php', obj, function(data) {
		acData = JSON.parse(data);
		var ymdOld = "**";
		var ipOld = "**";
		for ( var i=0; i<acData.length; i++ ) {
			var wk = [];
			var sameFlg = "Y";
			wk[0] = i+1;
			wk[1] = acData[i]['日付'].substr(0,10);
			if ( acData[i]['日付'].substr(0,10) != ymdOld ) {
				var cnt = 1;
				ymdOld = acData[i]['日付'].substr(0,10);
				ipOld = acData[i]['IPADDR'];
				var sameFlg = "N";
			}
			if ( acData[i]['IPADDR'] != ipOld ) {
				cnt ++;
				ipOld = acData[i]['IPADDR'];
				var sameFlg = "N";
			}
			wk[2] = String(cnt);
			wk[3] = acData[i]['IPADDR'];
			wk[4] = acData[i]['日付'].substr(11,5);
			wk[5] = acData[i]['日付'].substr(16);
			wk[6] = acData[i]['memo'];
			acTbl.push(wk);
		}
		disp_acTbl();
	});
}
function disp_acTbl() {
//	console.log(acTbl);
	var t = [];
	var oldym = "yy/mm";
	for ( var i=0; i<acTbl.length; i++ ) {
		if ( acTbl[i][1].substr(0,7) != oldym ) {
			oldym = acTbl[i][1].substr(0,7);
			t.push( [oldym, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] );
			var p = t.length - 1;
		}
		var dd = Number( acTbl[i][1].substr(8,2) );
		t[p][dd+2] = Number( acTbl[i][2] );
	}
	for ( var i=t.length-1; i>=0; i-- ) {
		for ( var j=3; j<t[0].length; j++ ) {		// 月計
			t[i][2] += t[i][j];
		}
		if ( i==t.length-1 ) {								// 累計
			t[i][1] += t[i][2];
		} else {
			t[i][1] = t[i+1][1] + t[i][2];
		}
	}
	var h = "<table style='margin:0 auto;'><thead><tr><th class='w1'>年/月<th class='w2'>累計<th class='w3'>月計";
		for (var dd=1; dd<=31; dd++) {
		h += "<th class='w4'>" + String(dd);
	}
	h += "</thead><tbody>";
	for ( var i=0; i<t.length; i++ ) {
		var s = " class='clk' onclick='dispDetail(" + '"' + String(t[i][0]) + '"' + "," + '"mm");' + "'";
		h += "<tr><td" + s + ">" + t[i][0] + "<td>" + String(t[i][1]) + "<td" + s + ">" + String(t[i][2]);
		for ( var j=3; j<t[0].length; j++ ) {
			if ( t[i][j]==0 ) {
				h += "<td>";
			} else {
				var s = " class='clk' onclick='dispDetail(" + '"' + String(t[i][0]) + '"' + ',"' + String(j-2) + '");' + "'";
				h += "<td" + s + ">" + String(t[i][j]);
			}
		}
	}
	h += "</tbody></table>";
	$("#t_area").html(h);
}
function dispDetail(ym, dd) {
//console.log(ym, typeof(ym));
//console.log(dd, typeof(dd));
	var obj = {};
	obj['id']  = 'select';
	obj['db']  = 'count/count.db';
	var sql = "select * from history where ";
	if ( dd == "mm" ) {
		sql += "substr(日付,1,7)='" + ym + "'";
	} else if ( dd.length == 1 ) {
		sql += "substr(日付,1,10)='" + ym+"/0"+String(dd) + "'";
	} else {
		sql += "substr(日付,1,10)='" + ym+"/"+String(dd) + "'";
	}
	sql += " order by IPADDR,日付 desc;";
	obj['sql']  = sql;
	$.post('../misato.php', obj, function(rs) {
		var data = JSON.parse(rs);
		var t = "<table class='tablesorter' id='dTbl'><thead><tr><th>No<th>日付時刻<th>IP Addr<th>userAgent</thead><tbody>";
		var oldIP = "*******";
		var oldIP_n = 0;
		for ( var i=0; i<data.length; i++ ) {
			t += "<tr><td class='left'>" + String(i+1);
			if ( data[i]["IPADDR"] != oldIP ) {
				oldIP_n ++;
				t += "-" + String(oldIP_n);
				oldIP = data[i]["IPADDR"];
			}
			t += "<td>" + data[i]["日付"].substr(0,16);
			t += "<td class='left'>" + data[i]["IPADDR"];
			t += "<td class='left'>" + data[i]["memo"];
		}
		t += "</tbody></table>";
		$("#detail").html(t);
		$("#dTbl").tablesorter();
	});
}
</script>
</body>
</html>